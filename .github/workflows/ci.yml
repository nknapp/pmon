name: ci

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

permissions:
  contents: read


jobs:
  test:
    name: test
    runs-on: ubuntu-latest

  build:
    name: build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
          - macos-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Rust environment
        uses: ./.github/actions/setup-rust-env

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          ./scripts/install-linux-deps.sh
          mise run init
          mise run lint
          mise run test

      - name: Build (macOS bundle)
        if: matrix.os == 'macos-latest'
        run: pnpm exec tauri build --bundles app,dmg

      - name: Build
        if: matrix.os != 'macos-latest'
        run: mise run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pmon-${{ matrix.os }}
          if-no-files-found: warn
          path: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/rpm/*.rpm
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/dmg/*.dmg
            src-tauri/target/release/bundle/macos/*.app
            src-tauri/target/release/pmon

      - name: Sccache stats
        run: sccache --show-stats
