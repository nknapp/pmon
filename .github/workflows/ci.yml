name: ci

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

env:
  CARGO_HOME: ${{ github.workspace }}/.cargo
  CARGO_TARGET_DIR: ${{ github.workspace }}/src-tauri/target
  RUSTUP_HOME: ${{ github.workspace }}/.rustup
  PNPM_STORE_DIR: ${{ github.workspace }}/.pnpm-store
  MISE_TRUSTED_CONFIG_PATHS: ${{ github.workspace }}/mise.toml
  SCCACHE_DIR: ${{ github.workspace }}/.sccache
  MISE_VERBOSE: 1

jobs:
  build:
    name: build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
          - macos-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Setup mise
        uses: jdx/mise-action@v2
        with:
          install: true
          cache: true
          env: false

      - name: Install dependencies
        run: mise run init

      - name: Lint
        run: mise run lint

      - name: Test
        run: mise run test

      - name: Build (macOS bundle)
        if: matrix.os == 'macos-latest'
        run: pnpm exec tauri build --bundles app,dmg

      - name: Build
        if: matrix.os != 'macos-latest'
        run: mise run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pmon-${{ matrix.os }}
          if-no-files-found: warn
          path: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/rpm/*.rpm
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/dmg/*.dmg
            src-tauri/target/release/bundle/macos/*.app
            src-tauri/target/release/pmon
